pipeline {  
    agent {
      kubernetes { 
         label 'dotnet5-sonar'
         defaultContainer 'dotnet5-sonar'
      }
    }

    options {
      buildDiscarder(logRotator(numToKeepStr: '5', artifactNumToKeepStr: '5'))
      disableConcurrentBuilds()
      skipDefaultCheckout()
    }
  
    stages {      
        stage('Sonar & Testes') {
        parallel {
          stage('TesteIntegracao & build'){
            steps{
              checkout scm
              script{
                  withSonarQubeEnv('sonarqube-local'){
                    sh 'dotnet-sonarscanner begin /k:"SME-NovoSGP" /d:sonar.cs.opencover.reportsPaths="teste/SME.SGP.TesteIntegracao/coverage.opencover.xml" /d:sonar.coverage.exclusions="**Test*.cs, **/*SME.SGP.Dados.*, **/*SME.SGP.Dominio.Interfaces, **/*SME.SGP.Api, **/*SME.SGP.Infra, **/*SME.SGP.IoC, **/*SME.SGP.Infra.*, **/*/Workers/*, **/*/Hub/*"'
                    sh 'dotnet build SME.SGP.sln'
                    sh 'dotnet test teste/SME.SGP.TesteIntegracao --no-build /p:CollectCoverage=true /p:CoverletOutputFormat=opencover'
                    sh 'dotnet-sonarscanner end'
                  }
               }
            }
          }
          stage('TesteIntegracao.AEE'){
            steps{
              checkout scm
              script{
                  sh 'dotnet test teste/SME.SGP.TesteIntegracao.AEE /p:CollectCoverage=true /p:CoverletOutputFormat=opencover'
               }
            }
          }
          stage('TesteIntegracao.Aula'){
            steps{
              checkout scm
              script{
                  sh 'dotnet test teste/SME.SGP.TesteIntegracao.Aula /p:CollectCoverage=true /p:CoverletOutputFormat=opencover'
              }
            }
          }
          stage('TesteIntegracao.Fechamento'){
            steps{
              checkout scm
              script{
                sh 'dotnet test teste/SME.SGP.TesteIntegracao.Fechamento /p:CollectCoverage=true /p:CoverletOutputFormat=opencover'
              }
            }
          }
          stage('TesteIntegracao.Frequencia'){
            steps{
              checkout scm
              script{
                sh 'dotnet test teste/SME.SGP.TesteIntegracao.Frequencia /p:CollectCoverage=true /p:CoverletOutputFormat=opencover'
              }
            }
          }
        }
      }       
    }
  }
